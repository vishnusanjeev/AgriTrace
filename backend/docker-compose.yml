services:
  mysql:
    image: mysql:8.0
    container_name: agritrace-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: agritrace
      MYSQL_USER: agritrace
      MYSQL_PASSWORD: agritrace
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - ./docker/mysql_data:/var/lib/mysql
      - ./api/schema_query.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro

  hardhat:
    image: node:18-bullseye
    container_name: agritrace-hardhat
    working_dir: /app
    volumes:
      - ./agritrace_chain_bridge:/app
    ports:
      - "8545:8545"
    command: >
      sh -c "npm install &&
             npx hardhat node --hostname 0.0.0.0"

  bridge:
    image: node:18-bullseye
    container_name: agritrace-bridge
    working_dir: /app
    depends_on:
      - hardhat
    environment:
      RPC_URL: http://hardhat:8545
      PRIVATE_KEY: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      BRIDGE_PORT: 5055
    volumes:
      - ./agritrace_chain_bridge:/app
    ports:
      - "5055:5055"
    command: >
      sh -c "npm install &&
             node scripts/auto_start_bridge.js"

  api:
    build:
      context: .
      dockerfile: docker/api.Dockerfile
    container_name: agritrace-api
    depends_on:
      - mysql
      - bridge
    environment:
      DB_HOST: mysql
      DB_NAME: agritrace
      DB_USER: agritrace
      DB_PASS: agritrace
      CHAIN_BRIDGE_URL: http://bridge:5055
      JWT_SECRET: 9f6c1d4a2b7e3c5d8f0a1b2c3d4e5f60718293a4b5c6d7e8f9a0b1c2d3e4f5a6
    volumes:
      - ./api:/var/www/html
    ports:
      - "8080:80"
